(()=>{"use strict";window.debounce=function(e){window.setTimeout((function(){e()}),window.constants.DEBOUNCE_INTERVAL)},window.constants={TYPES_VALUES:["bungalow","flat","house","palace"],MIN_PRICES:["0","1000","5000","10000"],TIMES_VALUES:["12:00","13:00","14:00"],GUESTS_VALUES:["1","2","3","0"],ROOMS_VALUES:["1","2","3","100"],FILE_TYPES:["gif","jpg","jpeg","png"],MAX_ANNOUNCEMENTS:8,ROUND_MAP_PIN_SIZE:62,ACTIVE_MAP_PIN_SIZE:62,ACTIVE_MAP_PIN_EDGE_HEIGHT:20,TIMEOUT_IN_MS:1e4,ESCAPE:"Escape",LOAD_URL:"https://21.javascript.pages.academy/keksobooking/data",UPLOAD_URL:"https://21.javascript.pages.academy/keksobooking",FILTERED_PINS_AMOUNT:5,VALID_FILE_TYPES:["image/jpeg","image/png","image/jpg"],DEBOUNCE_INTERVAL:500,MapInitialCoords:{x:570,y:375},ErrorMessages:{valueMissing:"Пожалуйста, заполните форму!",wrongRoom:"Вы выбрали количество мест, не соответствующее количеству гостей",emptyItem:"Пожалуйста, заполните поле",badInput:"Вы ввели неверный тип данных",patternMismatch:"Данные не соответствуют шаблону",rangeOverflow:"Превышено максимальное значение",rangeUnderflow:"Значение ниже минимального",stepMismatch:"Превышен шаг",tooLong:"Превышена максимальная длина",tooShort:"Количество введенных символов ниже минимального",typeMismatch:"Пожалуйста, проверьте правильность ввода",noFilesSelected:"Не выбран файл для загрузки",wrongTypeOfFile:"Разрешены только файлы в формате: jpeg, png, jpg"},NetworkErrorMessages:{wrongResponse:"Неверный запрос",unauthorizedResponse:"Пользователь не авторизован",notFoundResponse:"Данные не найдены",internalErrorResponse:"Произошла ошибка сервера"},PricesTypes:{low:1e4,middle:5e4},SuccessMessages:{dataSent:"Отправка данных прошла успешно!"},ResponseStatuses:{successResponse:200,wrongResponse:400,unauthorizedResponse:401,notFoundResponse:404,internalErrorResponse:500},OfferTypes:{Palace:"palace",Bungalo:"bungalow",House:"house",Flat:"flat"},CoordY:{MIN:130,MAX:630},FilterValues:{any:"any",low:"low",middle:"middle",high:"high"}},(()=>{const e=(e,t,n,o)=>{let s=new XMLHttpRequest;return s.responseType="json",s.addEventListener("load",(()=>{let e;switch(s.status){case window.constants.ResponseStatuses.successResponse:n(s.response);break;case window.constants.ResponseStatuses.wrongResponse:e=window.constants.NetworkErrorMessages.wrongResponse;break;case window.constants.ResponseStatuses.unauthorizedResponse:e=window.constants.NetworkErrorMessages.unauthorizedResponse;break;case window.constants.ResponseStatuses.notFoundResponse:e=window.constants.NetworkErrorMessages.notFoundResponse;break;case window.constants.ResponseStatuses.internalErrorResponse:e=window.constants.NetworkErrorMessages.internalErrorResponse;break;default:e=`Статус ответа: ${s.status} | ${s.statusText}`}e&&o(e)})),s.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=window.constants.TIMEOUT_IN_MS,s.open(e,t),s};window.network={load:(t,n)=>{e("GET",window.constants.LOAD_URL,t,n).send()},upload:(t,n,o)=>{e("POST",window.constants.UPLOAD_URL,n,o).send(t)}}})(),window.utils={fragment:document.createDocumentFragment(),generateRandomValue:(e,t)=>Math.floor(Math.random()*(t-e)+e),generateRandomArray:(e,t)=>{const n=[];for(let o=0;o<t;o++)n.push(e[o]);return n},hideElement:e=>{e.classList.add("hidden")},syncFields:(e,t,n,o,s)=>{s(t,o[n.indexOf(e.value)])},checkUndefinedValue:(e,t,n)=>{e||t.classList.add("hidden"),n()},removeSymbolsFromString:(e,t)=>e.substring(0,e.length-t),checkMouseDownEvent:(e,t,n)=>{e.button===t&&n()},checkKeyDownEvent:(e,t,n)=>{e.key===t&&n()},enterTextContent:(e,t)=>{e.textContent=t},makeRedBorder:e=>{e.classList.add("input--error")},removeRedBorder:e=>{e.classList.remove("input--error")},syncValue:(e,t)=>{e.value=t},syncValueWithMin:(e,t)=>{e.min=t,e.placeholder=t},syncGuestWithRooms:(e,t)=>{e.value=t;const n=e.value;Array.from(e).forEach((e=>{e.disabled="0"===n?"0"!==e.value:e.value>n||"0"===e.value}))},getAvatarNumber:e=>+e.match(/\d+/)[0]},(()=>{const e=document.forms[1],t=e.title,n=e.type,o=e.address,s=e.price,r=e.timein,i=e.timeout,a=e.rooms,d=e.capacity,c=e.avatar,l=e.images,w=e.features,u=e.querySelector(".ad-form-header__preview"),p=e.querySelector(".ad-form__photo"),m=e.querySelector(".ad-form-header"),f=e.querySelector(".ad-form__photo-container").parentNode,y=e.querySelector("button[type=submit]"),E=e.querySelector(".ad-form__reset"),h=[],v=(t,n)=>{t.setCustomValidity(n),window.utils.makeRedBorder(t),t.parentNode.setAttribute("valid","false"),e.reportValidity()},S=(t,n,o)=>{t.setCustomValidity(o),window.utils.makeRedBorder(t),n.setAttribute("valid","false"),e.reportValidity()},_=(e,t)=>{for(let n of e.files)window.constants.VALID_FILE_TYPES.forEach((o=>{n.type===o&&(window.utils.removeRedBorder(e),e.setCustomValidity(""),t.setAttribute("valid","true")),S(e,t,window.constants.ErrorMessages.wrongTypeOfFile)}));return window.utils.removeRedBorder(e),t.setAttribute("valid",!0),e.setCustomValidity(""),!0},g=t=>{t.validity.valueMissing?v(t,window.constants.ErrorMessages.valueMissing):t.validity.wrongRoom?v(t,window.constants.ErrorMessages.wrongRoom):t.validity.emptyItem?v(t,window.constants.ErrorMessages.emptyItem):t.validity.badInput?v(t,window.constants.ErrorMessages.badInput):t.validity.patternMismatch?v(t,window.constants.ErrorMessages.patternMismatch):t.validity.rangeOverflow?v(t,window.constants.ErrorMessages.rangeOverflow):t.validity.rangeUnderflow?v(t,window.constants.ErrorMessages.rangeUnderflow):t.validity.stepMismatch?v(t,window.constants.ErrorMessages.stepMismatch):t.validity.tooLong?v(t,window.constants.ErrorMessages.tooLong):t.validity.tooShort?v(t,window.constants.ErrorMessages.tooShort):t.validity.typeMismatch?v(t,window.constants.ErrorMessages.typeMismatch):(window.utils.removeRedBorder(t),t.setCustomValidity(""),t.parentNode.setAttribute("valid","true"),e.reportValidity())},A=e=>{const t=document.querySelectorAll(".success");t&&t.forEach((e=>{e.remove()}));const n=document.querySelector("#"+e).content.cloneNode(!0),o=document.createDocumentFragment();o.appendChild(n),document.querySelector("main").appendChild(o);const s=()=>{null!==document.querySelector("."+e)&&(document.querySelector("main").removeChild(document.querySelector("."+e)),document.removeEventListener("click",i),document.removeEventListener("keydown",r))},r=e=>{e.key===window.constants.ESCAPE&&(e.preventDefault(),s())},i=()=>{s()};document.querySelector("."+e).addEventListener("click",i),document.addEventListener("click",i),document.addEventListener("keydown",r)},M=()=>{A("success"),window.map.makeMapInactive()},L=()=>{A("error"),window.map.makeMapInactive()},k=(e,t)=>{let n=new FileReader;n.addEventListener("load",(e=>{const n=e.target,o=document.createElement("div");o.className="ad-form__photo__preview",o.innerHTML=`<img src="${n.result}" title="${n.name}" width="25" height="25"/>`,t.insertBefore(o,null)})),n.readAsDataURL(e)},I=e=>{let t=new FileReader;t.addEventListener("load",(e=>{const t=e.target,n=u.querySelector("img");n.src=""+t.result,n.alt=""+t.name})),t.readAsDataURL(e)};l.addEventListener("change",(e=>{let t=e.target.files;p.innerHTML="";for(let e=0;e<t.length;e++){let n=t[e];n.type.match("image")&&k(n,p)}})),c.addEventListener("change",(e=>{let t=e.target.files;for(let e=0;e<t.length;e++){let n=t[e];n.type.match("image")&&I(n)}})),window.form={adFormElement:e,adFormElementFieldsets:e.querySelectorAll("fieldset"),activateForm(){window.utils.syncFields(a,d,window.constants.ROOMS_VALUES,window.constants.GUESTS_VALUES,window.utils.syncGuestWithRooms),window.utils.syncFields(n,s,window.constants.TYPES_VALUES,window.constants.MIN_PRICES,window.utils.syncValueWithMin),window.utils.syncFields(r,i,window.constants.TIMES_VALUES,window.constants.TIMES_VALUES,window.utils.syncValue),a.addEventListener("change",(()=>{window.utils.syncFields(a,d,window.constants.ROOMS_VALUES,window.constants.GUESTS_VALUES,window.utils.syncGuestWithRooms)})),n.addEventListener("change",(()=>{window.utils.syncFields(n,s,window.constants.TYPES_VALUES,window.constants.MIN_PRICES,window.utils.syncValueWithMin)})),r.addEventListener("change",(()=>{window.utils.syncFields(r,i,window.constants.TIMES_VALUES,window.constants.TIMES_VALUES,window.utils.syncValue)})),i.addEventListener("change",(()=>{window.utils.syncFields(i,r,window.constants.TIMES_VALUES,window.constants.TIMES_VALUES,window.utils.syncValue)})),w.forEach((e=>{e.addEventListener("change",(()=>{h.push(e.value)}))})),E.addEventListener("click",(e=>{e.preventDefault(),window.map.makeMapInactive()})),c.addEventListener("change",(()=>{_(c,m)})),l.addEventListener("change",(()=>{_(l,f)}))},checkFormValidity(){g(t),g(s),g(o)},interactWithForm(){g(t),g(s),g(d),t.addEventListener("input",(e=>{g(e.target)})),s.addEventListener("input",(e=>{g(e.target)}))},submitForm(){y.addEventListener("click",(t=>{var n;t.preventDefault(),this.activateForm(),this.checkFormValidity(),e.querySelectorAll("fieldset[valid=false]").length||(n=new FormData(document.querySelector(".ad-form")),window.network.upload(n,M,L))}))},setAddress:(e,t,n)=>{if("initial"===e){const e=(e,t,n)=>{let o=0;return"x"===e?o=Math.floor(+t+n/2):"y"===e&&(o=Math.floor(+t+n)),o},s=`${e("x",t,window.constants.ACTIVE_MAP_PIN_SIZE)}, ${e("y",n,window.constants.ACTIVE_MAP_PIN_SIZE)}`;o.setAttribute("value",s)}if("work"===e){const e=`${t}, ${n}`;o.setAttribute("value",e)}o.setAttribute("readonly","readonly")},disableForm:()=>{e.reset(),window.filter.filterForm.reset();const t=Array.from(p.childNodes),n=u.querySelector("img");t.forEach((e=>{e.remove()})),n.src="img/muffin-grey.svg",e.querySelectorAll("fieldset").forEach((e=>{e.setAttribute("disabled","true")})),window.card.removeCardElements(),e.classList.add("ad-form--disabled")}}})(),(()=>{const e=document.forms[0],t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),s=e.querySelector("#housing-guests"),r=e.querySelector("#housing-features"),i={type:window.constants.FilterValues.any,price:window.constants.FilterValues.any,guests:window.constants.FilterValues.any,rooms:window.constants.FilterValues.any,features:[]};window.filter={handleFilters:e=>{const a=[],d=e.slice(0,window.constants.FILTERED_PINS_AMOUNT);for(let e of d)a.push(e);const c=()=>{const e=a.filter((e=>((e,t)=>{switch(e){case window.constants.FilterValues.any:return t;default:return t.offer.type===i.type&&t}})(i.type,e)&&((e,t)=>{switch(e){case window.constants.FilterValues.any:return t;default:return t.offer.guests===+i.guests&&t}})(i.guests,e)&&((e,t)=>{switch(e){case window.constants.FilterValues.any:return t;default:return t.offer.rooms===+i.rooms&&t}})(i.rooms,e)&&((e,t)=>{switch(e){case window.constants.FilterValues.low:return t.offer.price<window.constants.PricesTypes.low&&t;case window.constants.FilterValues.middle:return t.offer.price>window.constants.PricesTypes.low&&t.offer.price<=window.constants.PricesTypes.middle&&t;case window.constants.FilterValues.high:return t.offer.price>window.constants.PricesTypes.middle&&t;default:return t}})(i.price,e)&&((e,t)=>{if(!e.length)return!0;let n=!0;for(let o=0;o<e.length;o++)if(!t.offer.features.includes(e[o])){n=!1;break}return n})(i.features,e)));window.card.getAnnouncements(e),window.card.removeCardElements(),window.pin.setupPins(e),window.pin.handlePinsAndCards(document.querySelectorAll(".map__pin[type=button]"))};t.addEventListener("change",(e=>{i.type=e.target.value,window.debounce(c)})),o.addEventListener("change",(e=>{i.rooms=e.target.value,window.debounce(c)})),s.addEventListener("change",(e=>{i.guests=e.target.value,window.debounce(c)})),n.addEventListener("change",(e=>{i.price=e.target.value,window.debounce(c)})),r.addEventListener("change",(()=>{let e=r.querySelectorAll("input:checked");const t=Array.from(e),n=[];t.forEach((e=>{const t=e.value;n.push(t)})),i.features=n,window.debounce(c)}))},filterForm:e}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector(".map__filters-container"),n=document.querySelector(".map__pin").style.left,o=document.querySelector(".map__pin").style.top,s=document.querySelector(".map");window.map={mapSelector:s,mapFiltersContainer:t,initialSetup:()=>{s.classList.add("map--faded"),e.setAttribute("disabled","true"),window.form.adFormElementFieldsets.forEach((e=>{e.setAttribute("disabled","true")}))},makeMapInactive:()=>{s.classList.add("map--faded"),e.setAttribute("disabled","true");const t=document.querySelector(".map__pin");t.style.left=window.constants.MapInitialCoords.x+"px",t.style.top=window.constants.MapInitialCoords.y+"px",window.form.setAddress("initial",window.constants.MapInitialCoords.x,window.constants.MapInitialCoords.y),window.card.removeCardElements(),window.form.disableForm(),document.querySelectorAll("button[type=button].map__pin").forEach((e=>{e.remove()}))},setMapActive(){e.removeAttribute("disabled"),window.form.adFormElementFieldsets.forEach((e=>{e.removeAttribute("disabled")})),window.form.adFormElement.classList.remove("ad-form--disabled"),s.classList.remove("map--faded");const t=window.utils.removeSymbolsFromString(n,2),r=window.utils.removeSymbolsFromString(o,2);window.form.setAddress("initial",t,r),window.network.load((e=>{(e=>{const t=e.slice(0,window.constants.FILTERED_PINS_AMOUNT);window.card.getAnnouncements(t),window.pin.setupPins(t),window.pin.handlePinsAndCards(document.querySelectorAll(".map__pin")),window.pin.moveMainPin(),window.filter.handleFilters(e),window.form.submitForm()})(e)}),(e=>{document.querySelector(".notice").insertAdjacentHTML("beforebegin",`<div class="error-message"><p>${e}</p></div>`)}))},workWithActiveMap(){window.pin.moveMainPin(),window.form.submitForm()}}})(),(()=>{const e=window.utils.fragment,t=document.querySelector(".map__pins"),n=document.querySelector("#pin").content,o=document.querySelector(".map__pin--main"),s=document.querySelector(".map__pin").style.left,r=document.querySelector(".map__pin").style.top,i=()=>{o.addEventListener("click",(e=>{window.map.mapSelector.classList.contains("map--faded")?window.utils.checkMouseDownEvent(e,0,window.map.setMapActive):window.utils.checkMouseDownEvent(e,0,window.map.workWithActiveMap)})),o.addEventListener("keydown",(e=>{window.map.mapSelector.classList.contains("map--faded")?window.utils.checkKeyDownEvent(e,"Enter",window.map.setMapActive):window.utils.checkKeyDownEvent(e,"Enter",window.map.workWithActiveMap)}))};window.pin={mapPinsElement:t,setupPins(o){var s;s=o,document.querySelectorAll(".map__pin[type=button]").forEach((e=>{e.remove()})),s.forEach((t=>{e.appendChild((e=>{const t=n.cloneNode(!0),o=t.querySelector(".map__pin"),s=t.querySelector("img"),r=window.utils.getAvatarNumber(e.author.avatar);return o.style.left=e.location.x+"px",o.style.top=e.location.y+35+"px",s.src=e.author.avatar,s.setAttribute("alt",e.offer.title),o.setAttribute("data-id",r),t})(t))})),t.appendChild(e)},initiatePins:()=>{if(window.map.mapSelector.classList.contains("map--faded")){const e=window.utils.removeSymbolsFromString(s,2),t=window.utils.removeSymbolsFromString(r,2);i(),window.form.setAddress("initial",e,t)}},handleMainPin:i,handlePinsAndCards:e=>{e.forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),window.card.announcements.forEach((t=>{+e.dataset.id===t.id&&window.card.fillDomWithAnnouncements(t)}))}))}))},moveMainPin:()=>{o.addEventListener("mousedown",(e=>{e.preventDefault();const t=window.map.mapSelector.clientWidth,n=window.constants.CoordY.MAX-window.constants.ACTIVE_MAP_PIN_SIZE,s=window.constants.CoordY.MIN-window.constants.ACTIVE_MAP_PIN_SIZE;let r={x:e.clientX,y:e.clientY};const i=e=>{e.preventDefault();let i=r.x-e.clientX,a=r.y-e.clientY;r={x:e.clientX,y:e.clientY};let d=o.offsetLeft-i,c=o.offsetTop-a;if(d>=-window.constants.ACTIVE_MAP_PIN_SIZE/2&&d<=t-window.constants.ACTIVE_MAP_PIN_SIZE/2&&c>=s&&c<=n){o.style.top=c+"px",o.style.left=d+"px";const e=Math.floor(c+window.constants.ACTIVE_MAP_PIN_SIZE),t=Math.floor(d+window.constants.ACTIVE_MAP_PIN_SIZE/2);window.form.setAddress("work",t,e)}},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)}))}}})(),(()=>{const e=[];window.card={fillDomWithAnnouncements:e=>{const t=window.utils.fragment,n=document.querySelector("#card").content,o=e;document.querySelectorAll(".map__card").forEach((e=>{e.remove()})),t.appendChild((()=>{const e=n.cloneNode(!0),t=e.querySelector(".popup__title"),s=e.querySelector(".popup__text--address"),r=e.querySelector(".popup__text--price"),i=e.querySelector(".popup__type"),a=e.querySelector(".popup__text--capacity"),d=e.querySelector(".popup__text--time"),c=e.querySelector(".popup__features"),l=e.querySelector(".popup__description"),w=e.querySelector(".popup__photos"),u=e.querySelector(".popup__photos img"),p=e.querySelector(".popup__avatar");return window.utils.checkUndefinedValue(o.title,t,(()=>{window.utils.enterTextContent(t,o.title)})),window.utils.checkUndefinedValue(o.address,s,(()=>{window.utils.enterTextContent(s,o.address)})),window.utils.checkUndefinedValue(o.price,r,(()=>{window.utils.enterTextContent(r,o.price+"₽/ночь")})),window.utils.checkUndefinedValue(o.rooms,a,(()=>{window.utils.checkUndefinedValue(o.guests,a,(()=>{window.utils.enterTextContent(a,`${o.rooms} комнаты для ${o.guests} гостей`)}))})),window.utils.checkUndefinedValue(o.checkin,d,(()=>{window.utils.checkUndefinedValue(o.checkout,d,(()=>{window.utils.enterTextContent(d,`Заезд после ${o.checkin}, выезд до ${o.checkout}`)}))})),window.utils.checkUndefinedValue(o.features,c,(()=>{o.features.forEach((e=>{c.textContent+=" "+e}))})),window.utils.checkUndefinedValue(o.description,l,(()=>{window.utils.enterTextContent(l,o.description)})),window.utils.checkUndefinedValue(o.photos,w,(()=>{w.innerHTML="",o.photos.forEach((e=>{const t=e,n=u.cloneNode(!0);n.classList.add("popup__photo"),n.setAttribute("width","45"),n.setAttribute("height","45"),n.setAttribute("alt",o.title),n.src=t,w.appendChild(n)}))})),window.utils.checkUndefinedValue(o.avatar,p,(()=>{p.src=o.avatar})),window.utils.checkUndefinedValue(o.type,i,(()=>{switch(o.type){case window.constants.OfferTypes.Palace:i.textContent="Дворец";break;case window.constants.OfferTypes.Flat:i.textContent="Квартира";break;case window.constants.OfferTypes.House:i.textContent="Дом";break;default:i.textContent="Бунгало"}})),e})()),window.map.mapSelector.insertBefore(t,window.map.mapFiltersContainer);const s=document.querySelector(".popup"),r=s.querySelector(".popup__close"),i=()=>{s.remove(),r.removeEventListener("click",d),document.removeEventListener("keydown",a)},a=e=>{window.utils.checkKeyDownEvent(e,"Escape",i)},d=()=>{i()};r.addEventListener("click",d),document.addEventListener("keydown",a)},getAnnouncements:t=>{for(let n of t){const t={};t.title=n.offer.title,t.avatar=n.author.avatar,t.address=n.offer.address,t.price=n.offer.price,t.rooms=n.offer.rooms,t.guests=n.offer.guests,t.type=n.offer.type,t.checkin=n.offer.checkin,t.checkout=n.offer.checkout,t.features=n.offer.features,t.description=n.offer.description,t.photos=n.offer.photos,t.location=n.location,t.id=window.utils.getAvatarNumber(n.author.avatar),e.push(t)}},announcements:e,removeCardElements:()=>{document.querySelectorAll(".map__card").forEach((e=>{e.remove()}))}}})(),window.map.initialSetup(),window.pin.initiatePins(),window.form.activateForm()})();